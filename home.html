<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stria Chat</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <style>
        /* Custom styles for primary and secondary colors and font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Primary color: Black */
            color: #ffffff; /* White text for contrast */
            -webkit-overflow-scrolling: touch;
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE/Edge */
            user-select: none; /* Standard */
        }
        .bg-primary {
            background-color: #000000;
        }
        .bg-secondary {
            background-color: #0000ff; /* Secondary color: Blue */
        }
        .text-secondary {
            color: #0000ff;
        }
        .border-secondary {
            border-color: #0000ff;
        }
        /* Hide elements initially until content is ready */
        [v-cloak] {
            display: none;
        }
        /* Hamburger icon styling */
        .hamburger-icon span {
            display: block;
            width: 25px;
            height: 3px;
            background-color: #ffffff;
            margin: 4px auto; /* Adjusted margin for 3 lines */
            transition: all 0.3s ease-in-out;
        }
        .hamburger-icon:hover span {
            background-color: #0000ff; /* Secondary color on hover */
        }
        /* Custom animation for profile popup */
        @keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @keyframes slideOutLeft {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }
        .profile-popup-enter-active {
            animation: slideInLeft 0.3s ease-out forwards;
        }
        .profile-popup-leave-active {
            animation: slideOutLeft 0.3s ease-in forwards;
        }
        /* Custom animation for modals (fade in/out) */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }
        .modal-enter-active {
            animation: fadeIn 0.2s ease-out forwards;
        }
        .modal-leave-active {
            animation: fadeOut 0.2s ease-in forwards;
        }

        /* Chat message styling */
        .message-bubble {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .message-bubble.sent {
            background-color: #0000ff; /* Secondary color for sent */
            align-self: flex-end;
            margin-left: auto;
            color: white;
        }
        .message-bubble.received {
            background-color: #333333; /* Dark gray for received */
            align-self: flex-start;
            margin-right: auto;
            color: white;
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
</head>
<body class="bg-primary flex items-center justify-center min-h-screen p-4">
    <div id="app" class="w-full max-w-md bg-gray-900 bg-opacity-70 rounded-xl shadow-lg p-8 space-y-6 flex flex-col items-center relative" v-cloak>
        <!-- Login Screen -->
        <section id="login-screen" class="w-full text-center" style="display: none;">
            <h1 class="text-4xl font-bold mb-6">Welcome to Stria</h1>
            <p class="text-gray-300 mb-8">Sign in to start chatting.</p>
            <button id="google-signin-button"
                    class="bg-secondary hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-full transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Sign in with Google
            </button>
            <p id="error-message" class="text-red-500 mt-4 text-sm"></p>
        </section>

        <!-- Home Screen -->
        <section id="home-screen" class="w-full h-full text-center relative flex flex-col" style="display: none;">
            <!-- Top Navigation Bar -->
            <div class="flex justify-between items-center p-4 w-full">
                <!-- Hamburger Menu Button (Top Left) -->
                <button id="hamburger-menu-button" class="p-2 rounded-full hover:bg-gray-700 transition duration-200 z-10">
                    <div class="hamburger-icon">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </button>

                <!-- Search Button (Top Right) -->
                <button id="search-button" class="p-2 rounded-full hover:bg-gray-700 transition duration-200 z-10">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>

            <!-- Main Content Area (Welcome/Chat List) -->
            <div class="flex-grow flex flex-col p-4 overflow-hidden">
                <!-- Welcome message (initially visible, then hidden if chats exist) -->
                <div id="welcome-message-container" class="flex flex-col items-center justify-center flex-grow">
                    <h1 class="text-4xl font-bold mb-4">Stria Home</h1>
                    <p class="text-gray-300 mb-8">Welcome back! Start a chat using the search button.</p>
                </div>

                <!-- Chat List Container -->
                <div id="chat-list-container" class="flex-grow overflow-y-auto hidden">
                    <p class="text-gray-400 text-center py-4">No active chats. Start one by searching for a user!</p>
                </div>
            </div>

            <!-- Profile Pop-up (Side Drawer style) -->
            <div id="profile-popup" class="fixed top-0 left-0 h-full w-64 bg-gray-900 bg-opacity-95 shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out z-40">
                <div class="p-6 flex flex-col items-center h-full relative">
                    <button id="close-profile-popup" class="absolute top-3 right-3 text-white hover:text-gray-400 text-3xl font-light">&times;</button>
                    <img id="profile-dp" src="https://placehold.co/100x100/000/fff?text=DP" alt="Profile Picture" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-secondary object-cover">
                    <p id="profile-name" class="text-xl font-bold mb-1 text-white"></p>
                    <p id="profile-email" class="text-gray-400 text-sm mb-2"></p>
                    <p id="profile-username" class="text-gray-300 text-sm">Username: <span class="font-semibold">Not Set</span></p>
                    <!-- Additional menu items can go here -->
                    <div class="mt-8 w-full">
                        <button id="settings-button" class="w-full text-left py-2 px-4 rounded-md hover:bg-gray-700 transition duration-200 text-white">Settings</button>
                        <button class="w-full text-left py-2 px-4 rounded-md hover:bg-gray-700 transition duration-200 text-white mt-2">Privacy</button>
                        <button class="w-full text-left py-2 px-4 rounded-md hover:bg-gray-700 transition duration-200 text-white mt-2">Help</button>
                        <button id="sign-out-button"
                                class="w-full text-left py-2 px-4 rounded-md bg-red-600 hover:bg-red-700 text-white font-semibold mt-4 transition duration-300 ease-in-out">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
                <div class="bg-gray-800 rounded-xl p-8 w-full max-w-sm relative shadow-lg modal-enter-active">
                    <button id="close-settings-modal" class="absolute top-3 right-3 text-white hover:text-gray-400 text-3xl font-light">&times;</button>
                    <h2 class="text-2xl font-bold mb-6 text-white text-center">Edit Profile</h2>

                    <div class="flex flex-col items-center mb-6">
                        <img id="settings-dp-preview" src="https://placehold.co/100x100/000/fff?text=DP" alt="Profile Picture" class="w-28 h-28 rounded-full mb-4 border-2 border-secondary object-cover">
                        <input type="file" id="dp-upload-input" accept="image/*" class="hidden">
                        <label for="dp-upload-input" class="bg-secondary hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full cursor-pointer transition duration-300 ease-in-out">
                            Change Display Picture
                        </label>
                    </div>

                    <div class="mb-4">
                        <label for="settings-name-input" class="block text-gray-300 text-sm font-bold mb-2 text-left">Name:</label>
                        <input type="text" id="settings-name-input" placeholder="Your Name"
                               class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-white">
                    </div>

                    <div class="mb-6">
                        <label for="settings-username-input" class="block text-gray-300 text-sm font-bold mb-2 text-left">Username:</label>
                        <input type="text" id="settings-username-input" placeholder="Your Username"
                               class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-white">
                    </div>
                    <p id="settings-message" class="text-sm text-center mb-4"></p>

                    <div class="flex justify-between">
                        <button id="save-settings-button"
                                class="bg-secondary hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-full transition duration-300 ease-in-out">
                            Save Changes
                        </button>
                        <button id="cancel-settings-button"
                                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-5 rounded-full transition duration-300 ease-in-out">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search Modal -->
            <div id="search-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
                <div class="bg-gray-800 rounded-xl p-8 w-full max-w-md relative shadow-lg modal-enter-active">
                    <button id="close-search-modal" class="absolute top-3 right-3 text-white hover:text-gray-400 text-3xl font-light">&times;</button>
                    <h2 class="text-2xl font-bold mb-6 text-white text-center">Find Users</h2>

                    <input type="text" id="search-username-input" placeholder="Search by username..."
                           class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-white mb-4">

                    <div id="search-results" class="max-h-64 overflow-y-auto bg-gray-700 rounded-lg p-2">
                        <!-- Search results will be dynamically inserted here -->
                        <p class="text-gray-400 text-center py-4">Start typing to find users.</p>
                    </div>
                    <p id="search-message" class="text-sm text-center mt-4"></p>
                </div>
            </div>

            <!-- Chat Modal -->
            <div id="chat-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
                <!-- Changed: w-full h-full for full screen, bg-primary for black background, removed rounded-xl -->
                <div class="bg-primary p-6 w-full h-full flex flex-col relative shadow-lg modal-enter-active">
                    <button id="close-chat-modal" class="absolute top-3 right-3 text-white hover:text-gray-400 text-3xl font-light">&times;</button>
                    <div class="flex items-center mb-4">
                        <!-- Removed border-2 border-secondary from chat-other-dp -->
                        <img id="chat-other-dp" src="https://placehold.co/50x50/000/fff?text=DP" alt="Other User DP" class="w-12 h-12 rounded-full mr-3 object-cover">
                        <h2 id="chat-other-name" class="text-xl font-bold text-white"></h2>
                    </div>

                    <!-- Changed: flex-col instead of flex-col-reverse -->
                    <div id="messages-container" class="flex-grow overflow-y-auto p-2 bg-gray-700 rounded-lg mb-4 flex flex-col">
                        <!-- Messages will be dynamically inserted here -->
                        <p class="text-gray-400 text-center py-4">No messages yet. Start a conversation!</p>
                    </div>

                    <div class="flex">
                        <input type="text" id="message-input" placeholder="Type your message..."
                               class="shadow appearance-none border rounded-l-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-white">
                        <button id="send-message-button"
                                class="bg-secondary hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-r-lg transition duration-300 ease-in-out">
                            Send
                        </button>
                    </div>
                    <p id="chat-message-status" class="text-sm text-center mt-2"></p>
                </div>
            </div>

            <!-- Overlay for closing popup when clicking outside -->
            <div id="profile-popup-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
        </section>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAXS0Mr9A9EgNHAr7tmtAkS0b2JyVdaHXc",
            authDomain: "stria-chat.firebaseapp.com",
            projectId: "stria-chat",
            storageBucket: "stria-chat.firebasestorage.app",
            messagingSenderId: "742772667117",
            appId: "1:742772667117:web:d748e7f308e272073512e4",
            measurementId: "G-3DX8081MT7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Get elements
        const appContainer = document.getElementById('app');
        const loginScreen = document.getElementById('login-screen');
        const homeScreen = document.getElementById('home-screen');
        const googleSignInButton = document.getElementById('google-signin-button');
        const errorMessage = document.getElementById('error-message');

        const hamburgerMenuButton = document.getElementById('hamburger-menu-button');
        const searchButton = document.getElementById('search-button');

        // Home Screen Content elements
        const welcomeMessageContainer = document.getElementById('welcome-message-container');
        const chatListContainer = document.getElementById('chat-list-container');


        // Profile Popup elements
        const profilePopup = document.getElementById('profile-popup');
        const closeProfilePopupButton = document.getElementById('close-profile-popup');
        const profilePopupOverlay = document.getElementById('profile-popup-overlay');
        const profileDp = document.getElementById('profile-dp');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUsername = document.getElementById('profile-username');
        const settingsButton = document.getElementById('settings-button');
        const signOutButton = document.getElementById('sign-out-button');

        // Settings Modal elements
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalButton = document.getElementById('close-settings-modal');
        const settingsDpPreview = document.getElementById('settings-dp-preview');
        const dpUploadInput = document.getElementById('dp-upload-input');
        const settingsNameInput = document.getElementById('settings-name-input');
        const settingsUsernameInput = document.getElementById('settings-username-input');
        const saveSettingsButton = document.getElementById('save-settings-button');
        const cancelSettingsButton = document.getElementById('cancel-settings-button');
        const settingsMessage = document.getElementById('settings-message');

        // Search Modal elements
        const searchModal = document.getElementById('search-modal');
        const closeSearchModalButton = document.getElementById('close-search-modal');
        const searchUsernameInput = document.getElementById('search-username-input');
        const searchResultsContainer = document.getElementById('search-results');
        const searchMessage = document.getElementById('search-message');

        // Chat Modal elements
        const chatModal = document.getElementById('chat-modal');
        const closeChatModalButton = document.getElementById('close-chat-modal');
        const chatOtherDp = document.getElementById('chat-other-dp');
        const chatOtherName = document.getElementById('chat-other-name');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message-button');
        const chatMessageStatus = document.getElementById('chat-message-status');

        let selectedFile = null; // To store the selected DP file
        let currentChatListener = null; // To store the Firestore snapshot listener for chat messages
        let currentChatPartner = null; // To store the UID of the user currently being chatted with
        let chatListListener = null; // To store the Firestore snapshot listener for the chat list

        // Function to show/hide screens and adjust app container styling
        function showScreen(screenId) {
            loginScreen.style.display = 'none';
            homeScreen.style.display = 'none';

            if (screenId === 'home-screen') {
                document.body.classList.remove('justify-center', 'items-center', 'p-4');
                appContainer.classList.remove('max-w-md', 'p-8', 'space-y-6', 'rounded-xl', 'shadow-lg', 'bg-gray-900', 'bg-opacity-70');
                appContainer.classList.add('w-full', 'h-screen', 'rounded-none', 'p-0', 'flex-col', 'items-center', 'justify-start', 'bg-primary');
                homeScreen.style.display = 'flex';
                // Start listening for the chat list when home screen is shown
                if (auth.currentUser) {
                    listenForChatList(auth.currentUser.uid);
                }
            } else if (screenId === 'login-screen') {
                document.body.classList.add('justify-center', 'items-center', 'p-4');
                appContainer.classList.add('max-w-md', 'p-8', 'space-y-6', 'rounded-xl', 'shadow-lg', 'bg-gray-900', 'bg-opacity-70');
                appContainer.classList.remove('w-full', 'h-screen', 'rounded-none', 'p-0', 'flex-col', 'items-center', 'justify-start', 'bg-primary');
                loginScreen.style.display = 'block';
                // Stop listening for chat list when logging out
                if (chatListListener) {
                    chatListListener();
                    chatListListener = null;
                }
            }
            appContainer.removeAttribute('v-cloak');
        }

        // --- Profile Popup Functions ---
        function openProfilePopup() {
            const user = auth.currentUser;
            if (user) {
                profileDp.src = user.photoURL || 'https://placehold.co/100x100/000/fff?text=DP';
                profileName.textContent = user.displayName || 'Guest User';
                profileEmail.textContent = user.email || 'No email provided';

                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists && doc.data().username) {
                        profileUsername.querySelector('span').textContent = doc.data().username;
                    } else {
                        profileUsername.querySelector('span').textContent = 'Not Set';
                    }
                }).catch(error => {
                    console.error("Error fetching username:", error);
                    profileUsername.querySelector('span').textContent = 'Error';
                });
            }

            profilePopup.classList.remove('-translate-x-full');
            profilePopupOverlay.classList.remove('hidden');
        }

        function closeProfilePopup() {
            profilePopup.classList.add('-translate-x-full');
            profilePopupOverlay.classList.add('hidden');
        }

        // --- Settings Modal Functions ---
        function openSettingsModal() {
            closeProfilePopup();
            const user = auth.currentUser;
            if (user) {
                settingsDpPreview.src = user.photoURL || 'https://placehold.co/100x100/000/fff?text=DP';
                settingsNameInput.value = user.displayName || '';

                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists && doc.data().username) {
                        settingsUsernameInput.value = doc.data().username;
                    } else {
                        settingsUsernameInput.value = '';
                    }
                }).catch(error => {
                    console.error("Error loading username for settings:", error);
                    settingsUsernameInput.value = '';
                });
            }
            settingsMessage.textContent = '';
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('modal-enter-active');
        }

        function closeSettingsModal() {
            settingsModal.classList.remove('modal-enter-active');
            settingsModal.classList.add('modal-leave-active');
            settingsModal.addEventListener('animationend', function handler() {
                settingsModal.classList.add('hidden');
                settingsModal.classList.remove('modal-leave-active');
                settingsModal.removeEventListener('animationend', handler);
            });
            selectedFile = null;
            dpUploadInput.value = '';
        }

        // --- Search Modal Functions ---
        function openSearchModal() {
            searchModal.classList.remove('hidden');
            searchModal.classList.add('modal-enter-active');
            searchUsernameInput.value = ''; // Clear previous search
            searchResultsContainer.innerHTML = '<p class="text-gray-400 text-center py-4">Start typing to find users.</p>';
            searchMessage.textContent = '';
        }

        function closeSearchModal() {
            searchModal.classList.remove('modal-enter-active');
            searchModal.classList.add('modal-leave-active');
            searchModal.addEventListener('animationend', function handler() {
                searchModal.classList.add('hidden');
                searchModal.classList.remove('modal-leave-active');
                searchModal.removeEventListener('animationend', handler);
            });
        }

        // --- Chat Modal Functions ---
        function openChatModal(chatPartnerUser) {
            closeSearchModal(); // Close search modal when opening chat
            chatOtherDp.src = chatPartnerUser.photoURL || 'https://placehold.co/50x50/000/fff?text=DP';
            chatOtherName.textContent = chatPartnerUser.displayName || chatPartnerUser.username || 'Unknown User';
            currentChatPartner = chatPartnerUser; // Store the chat partner object

            messagesContainer.innerHTML = '<p class="text-gray-400 text-center py-4">Loading messages...</p>';
            messageInput.value = '';
            chatMessageStatus.textContent = '';

            // Make chat modal full screen
            chatModal.classList.remove('hidden');
            chatModal.classList.add('modal-enter-active');
            // Ensure the inner div of the chat modal takes full width and height
            chatModal.querySelector('div').classList.add('w-full', 'h-full');
            chatModal.querySelector('div').classList.remove('max-w-xl', 'h-5/6', 'rounded-xl'); // Removed rounded-xl here

            // Start listening for messages
            listenForMessages(auth.currentUser.uid, chatPartnerUser.uid);
        }

        function closeChatModal() {
            chatModal.classList.remove('modal-enter-active');
            chatModal.classList.add('modal-leave-active');
            chatModal.addEventListener('animationend', function handler() {
                chatModal.classList.add('hidden');
                chatModal.classList.remove('modal-leave-active');
                // Revert full screen classes on close
                chatModal.querySelector('div').classList.remove('w-full', 'h-full');
                chatModal.querySelector('div').classList.add('max-w-xl', 'h-5/6', 'rounded-xl'); // Added rounded-xl back here

                chatModal.removeEventListener('animationend', handler);
                if (currentChatListener) {
                    currentChatListener(); // Unsubscribe from previous chat listener
                    currentChatListener = null;
                }
                currentChatPartner = null;
            });
        }

        // --- Firebase Core Logic ---
        // Event listener for Google Sign-in
        googleSignInButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('User signed in:', result.user.displayName);
                    errorMessage.textContent = '';
                    // Create/update user document in Firestore
                    const userRef = db.collection('users').doc(result.user.uid);
                    userRef.get().then(docSnapshot => {
                        if (!docSnapshot.exists) {
                            userRef.set({
                                name: result.user.displayName,
                                email: result.user.email,
                                photoURL: result.user.photoURL,
                                username: null // Initialize username as null
                            });
                        } else {
                            // Update existing user data if needed (e.g., if DP or name changed in Google)
                            userRef.update({
                                name: result.user.displayName,
                                photoURL: result.user.photoURL,
                                email: result.user.email // Ensure email is also updated
                            });
                        }
                    });
                })
                .catch((error) => {
                    const errorMessageText = error.message;
                    console.error('Google Sign-in Error:', errorMessageText);
                    errorMessage.textContent = `Error: ${errorMessageText}`;
                });
        });

        // Event listener for Sign Out
        signOutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                console.log('User signed out.');
                closeProfilePopup();
                closeSettingsModal();
                closeSearchModal();
                closeChatModal();
            }).catch((error) => {
                console.error('Sign out error:', error);
                errorMessage.textContent = `Sign out error: ${error.message}`;
            });
        });

        // Firebase Auth State Observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                showScreen('home-screen');
            } else {
                showScreen('login-screen');
            }
        });

        // --- Event Listeners for UI Interactions ---
        hamburgerMenuButton.addEventListener('click', openProfilePopup);
        closeProfilePopupButton.addEventListener('click', closeProfilePopup);
        profilePopupOverlay.addEventListener('click', closeProfilePopup);

        settingsButton.addEventListener('click', openSettingsModal);
        closeSettingsModalButton.addEventListener('click', closeSettingsModal);
        cancelSettingsButton.addEventListener('click', closeSettingsModal);

        searchButton.addEventListener('click', openSearchModal);
        closeSearchModalButton.addEventListener('click', closeSearchModal);

        closeChatModalButton.addEventListener('click', closeChatModal);
        sendMessageButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- Settings Logic ---
        dpUploadInput.addEventListener('change', (event) => {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    settingsDpPreview.src = e.target.result;
                };
                reader.readAsDataURL(selectedFile);
            }
        });

        saveSettingsButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                settingsMessage.textContent = 'Error: No user logged in.';
                settingsMessage.style.color = '#ff4d4d';
                return;
            }

            const newName = settingsNameInput.value.trim();
            const newUsername = settingsUsernameInput.value.trim();
            let photoURL = user.photoURL;

            settingsMessage.textContent = 'Saving...';
            settingsMessage.style.color = '#0000ff';

            try {
                if (selectedFile) {
                    const storageRef = storage.ref();
                    const dpRef = storageRef.child(`profile_pictures/${user.uid}/${selectedFile.name}`);
                    const uploadTask = dpRef.put(selectedFile);

                    await uploadTask;
                    photoURL = await dpRef.getDownloadURL();
                }

                await user.updateProfile({
                    displayName: newName,
                    photoURL: photoURL
                });

                const userDocRef = db.collection('users').doc(user.uid);
                await userDocRef.set({
                    username: newUsername,
                    name: newName,
                    photoURL: photoURL
                }, { merge: true });

                settingsMessage.textContent = 'Profile updated successfully!';
                settingsMessage.style.color = '#4CAF50';

                openProfilePopup();
                closeSettingsModal();
            } catch (error) {
                console.error("Error saving profile:", error);
                settingsMessage.textContent = `Error: ${error.message}`;
                settingsMessage.style.color = '#ff4d4d';
            }
        });

        // --- Search Logic ---
        searchUsernameInput.addEventListener('input', debounce(async (event) => {
            const searchTerm = event.target.value.trim();
            searchResultsContainer.innerHTML = ''; // Clear previous results
            searchMessage.textContent = '';

            if (searchTerm.length < 2) {
                searchResultsContainer.innerHTML = '<p class="text-gray-400 text-center py-4">Start typing to find users.</p>';
                return;
            }

            const currentUser = auth.currentUser;
            if (!currentUser) {
                searchMessage.textContent = 'Please log in to search for users.';
                searchMessage.style.color = '#ff4d4d';
                return;
            }

            try {
                const usersRef = db.collection('users');
                const querySnapshot = await usersRef
                    .where('username', '>=', searchTerm)
                    .where('username', '<=', searchTerm + '\uf8ff')
                    .limit(10)
                    .get();

                if (querySnapshot.empty) {
                    searchResultsContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No users found.</p>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const userData = doc.data();
                    const userId = doc.id;

                    if (userId === currentUser.uid) {
                        return;
                    }

                    const userResultDiv = document.createElement('div');
                    userResultDiv.classList.add('flex', 'items-center', 'p-3', 'rounded-lg', 'hover:bg-gray-600', 'cursor-pointer', 'mb-2', 'transition', 'duration-200');
                    userResultDiv.innerHTML = `
                        <img src="${userData.photoURL || 'https://placehold.co/50x50/000/fff?text=DP'}" alt="DP" class="w-10 h-10 rounded-full mr-3 border border-gray-500 object-cover">
                        <div>
                            <p class="text-white font-semibold">${userData.name || 'Unknown'}</p>
                            <p class="text-gray-400 text-sm">@${userData.username || 'N/A'}</p>
                        </div>
                    `;
                    userResultDiv.addEventListener('click', () => {
                        openChatModal({
                            uid: userId,
                            displayName: userData.name,
                            photoURL: userData.photoURL,
                            username: userData.username
                        });
                    });
                    searchResultsContainer.appendChild(userResultDiv);
                });

            } catch (error) {
                console.error("Error searching users:", error);
                searchMessage.textContent = `Error searching: ${error.message}`;
                searchMessage.style.color = '#ff4d4d';
            }
        }, 300));

        // Debounce function
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // --- Chat Logic ---
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText || !auth.currentUser || !currentChatPartner) {
                chatMessageStatus.textContent = 'Cannot send empty message or no chat partner selected.';
                chatMessageStatus.style.color = '#ff4d4d';
                return;
            }

            const senderId = auth.currentUser.uid;
            const receiverId = currentChatPartner.uid;

            const chatId = [senderId, receiverId].sort().join('_');

            try {
                const chatDocRef = db.collection('chats').doc(chatId);
                const message = {
                    senderId: senderId,
                    text: messageText,
                    timestamp: new Date() // Client-side timestamp for array element
                };

                await chatDocRef.set({
                    participants: [senderId, receiverId],
                    lastMessage: messageText,
                    lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp(), // Server timestamp for top-level field
                    messages: firebase.firestore.FieldValue.arrayUnion(message)
                }, { merge: true });

                messageInput.value = '';
                chatMessageStatus.textContent = '';
                // messagesContainer.scrollTop = messagesContainer.scrollHeight; // This will be handled by displayMessages
            } catch (error) {
                console.error("Error sending message:", error);
                chatMessageStatus.textContent = `Error sending: ${error.message}`;
                chatMessageStatus.style.color = '#ff4d4d';
            }
        }

        function listenForMessages(user1Id, user2Id) {
            if (currentChatListener) {
                currentChatListener();
            }

            const chatId = [user1Id, user2Id].sort().join('_');
            const chatDocRef = db.collection('chats').doc(chatId);

            currentChatListener = chatDocRef.onSnapshot(docSnapshot => {
                if (docSnapshot.exists) {
                    const chatData = docSnapshot.data();
                    const messages = chatData.messages || [];
                    displayMessages(messages);
                } else {
                    messagesContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No messages yet. Start a conversation!</p>';
                }
                // messagesContainer.scrollTop = messagesContainer.scrollHeight; // This will be handled by displayMessages
            }, error => {
                console.error("Error listening for messages:", error);
                chatMessageStatus.textContent = `Error loading messages: ${error.message}`;
                chatMessageStatus.style.color = '#ff4d4d';
            });
        }

        function displayMessages(messages) {
            messagesContainer.innerHTML = '';
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No messages yet. Start a conversation!</p>';
                return;
            }

            messages.sort((a, b) => {
                const timestampA = a.timestamp instanceof firebase.firestore.Timestamp ? a.timestamp.toMillis() : a.timestamp?.getTime() || 0;
                const timestampB = b.timestamp instanceof firebase.firestore.Timestamp ? b.timestamp.toMillis() : b.timestamp?.getTime() || 0;
                return timestampA - timestampB;
            });


            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                const isSent = msg.senderId === auth.currentUser.uid;
                messageDiv.classList.add('message-bubble', isSent ? 'sent' : 'received');
                messageDiv.textContent = msg.text;
                messagesContainer.appendChild(messageDiv);
            });
            // Scroll to bottom after all messages are added
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- Chat List Logic ---
        async function listenForChatList(currentUserId) {
            if (chatListListener) {
                chatListListener(); // Unsubscribe from previous listener if exists
            }

            const chatsRef = db.collection('chats');
            chatListListener = chatsRef
                .where('participants', 'array-contains', currentUserId)
                .orderBy('lastMessageTimestamp', 'desc')
                .onSnapshot(async (snapshot) => {
                    chatListContainer.innerHTML = ''; // Clear existing list
                    const chatListItems = [];

                    if (snapshot.empty) {
                        welcomeMessageContainer.classList.remove('hidden');
                        chatListContainer.classList.add('hidden');
                        return;
                    } else {
                        welcomeMessageContainer.classList.add('hidden');
                        chatListContainer.classList.remove('hidden');
                    }

                    for (const doc of snapshot.docs) {
                        const chatData = doc.data();
                        const otherParticipantId = chatData.participants.find(uid => uid !== currentUserId);

                        if (otherParticipantId) {
                            try {
                                const otherUserDoc = await db.collection('users').doc(otherParticipantId).get();
                                if (otherUserDoc.exists) {
                                    const otherUserData = otherUserDoc.data();
                                    const lastMessage = chatData.lastMessage || "No messages yet.";
                                    const chatItemDiv = document.createElement('div');
                                    chatItemDiv.classList.add('flex', 'items-center', 'p-3', 'rounded-lg', 'hover:bg-gray-700', 'cursor-pointer', 'mb-2', 'transition', 'duration-200', 'border', 'border-gray-700');
                                    chatItemDiv.innerHTML = `
                                        <img src="${otherUserData.photoURL || 'https://placehold.co/50x50/000/fff?text=DP'}" alt="DP" class="w-12 h-12 rounded-full mr-4 border-2 border-secondary object-cover">
                                        <div class="flex-grow text-left">
                                            <p class="text-white font-semibold text-lg">${otherUserData.name || otherUserData.username || 'Unknown User'}</p>
                                            <p class="text-gray-400 text-sm truncate">${lastMessage}</p>
                                        </div>
                                    `;
                                    chatItemDiv.addEventListener('click', () => {
                                        openChatModal({
                                            uid: otherParticipantId,
                                            displayName: otherUserData.name,
                                            photoURL: otherUserData.photoURL,
                                            username: otherUserData.username
                                        });
                                    });
                                    chatListItems.push({ element: chatItemDiv, timestamp: chatData.lastMessageTimestamp });
                                }
                            } catch (error) {
                                console.error("Error fetching other user data for chat list:", error);
                            }
                        }
                    }

                    // Sort chat items by timestamp before appending (Firestore orderBy is for the query, not the elements themselves)
                    chatListItems.sort((a, b) => {
                        const timestampA = a.timestamp ? a.timestamp.toMillis() : 0;
                        const timestampB = b.timestamp ? b.timestamp.toMillis() : 0;
                        return timestampB - timestampA; // Descending order
                    });

                    chatListItems.forEach(item => chatListContainer.appendChild(item.element));

                }, error => {
                    console.error("Error listening for chat list:", error);
                    chatListContainer.innerHTML = `<p class="text-red-500 text-center py-4">Error loading chats: ${error.message}</p>`;
                });
        }
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker registered! Scope:', registration.scope);
                })
                .catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
        });
    }
</script>
</body>
</html>
